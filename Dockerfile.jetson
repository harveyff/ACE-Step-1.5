# NVIDIA Jetson optimized Dockerfile for ACE-Step 1.5
# 适用于：NVIDIA Jetson AGX Xavier, Orin, Nano 等设备
# 
# 前置要求：
# 1. 已安装 JetPack SDK（包含 CUDA, cuDNN, TensorRT）
# 2. 已安装 NVIDIA Container Toolkit
# 3. Docker 已配置为支持 GPU

# 使用 Jetson 官方基础镜像
# 根据你的 JetPack 版本选择合适的标签：
# - JetPack 5.x: r35.x.x (CUDA 11.4)
# - JetPack 6.x: r36.x.x (CUDA 12.x)
# 查看可用标签: https://catalog.ngc.nvidia.com/orgs/nvidia/containers/l4t-base
ARG JETPACK_VERSION=r35.2.1
FROM nvcr.io/nvidia/l4t-base:${JETPACK_VERSION}

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    DEBIAN_FRONTEND=noninteractive \
    CUDA_HOME=/usr/local/cuda \
    NVIDIA_VISIBLE_DEVICES=all \
    NVIDIA_DRIVER_CAPABILITIES=compute,utility

WORKDIR /app

# 安装系统依赖
# Jetson 通常使用 Ubuntu 20.04 或 22.04，Python 版本可能不同
RUN apt-get update && apt-get install -y \
    python3.11 python3.11-venv python3.11-dev \
    python3-pip \
    build-essential git curl wget sox libsox-dev libsndfile1 ffmpeg \
    ninja-build \
    bc \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# 如果 python3.11 不可用，使用 python3.10 或 python3
RUN if ! command -v python3.11 &> /dev/null; then \
        apt-get update && apt-get install -y python3.10 python3.10-venv python3.10-dev || \
        apt-get update && apt-get install -y python3 python3-venv python3-dev; \
    fi

# 创建 Python 符号链接
RUN if command -v python3.11 &> /dev/null; then \
        PYTHON_CMD=python3.11; \
    elif command -v python3.10 &> /dev/null; then \
        PYTHON_CMD=python3.10; \
    else \
        PYTHON_CMD=python3; \
    fi && \
    update-alternatives --install /usr/bin/python3 python3 $(which $PYTHON_CMD) 1 && \
    update-alternatives --install /usr/bin/python python $(which $PYTHON_CMD) 1

# 创建虚拟环境
RUN PYTHON_CMD=$(which python3.11 || which python3.10 || which python3) && \
    $PYTHON_CMD -m venv /app/.venv
ENV PATH="/app/.venv/bin:$PATH"

# 克隆官方 ACE-Step 1.5 项目
RUN git clone --recursive https://github.com/ACE-Step/ACE-Step-1.5.git .

# 安装 pip 和升级到最新版本
RUN pip install --upgrade pip setuptools wheel

# 安装 PyTorch for Jetson
# Jetson 需要使用预编译的 PyTorch wheel（从 NVIDIA 或 PyTorch 官方）
# 根据 CUDA 版本选择：
RUN CUDA_VER=$(nvcc --version | grep "release" | sed 's/.*release \([0-9]\+\.[0-9]\+\).*/\1/' 2>/dev/null || echo "11.4") && \
    echo "Detected CUDA version: $CUDA_VER" && \
    if [ "$(echo "$CUDA_VER >= 12.0" | bc -l 2>/dev/null || echo 0)" -eq 1 ]; then \
        echo "Installing PyTorch for CUDA 12.x" && \
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121 || \
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121; \
    else \
        echo "Installing PyTorch for CUDA 11.8 (Jetson compatible)" && \
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118 || \
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118; \
    fi || \
    echo "Installing default PyTorch for CUDA 11.8" && \
    pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# 安装其他依赖
RUN pip install transformers>=4.51.0,<4.58.0 \
        diffusers \
        gradio>=6.5.1 \
        matplotlib>=3.7.5 \
        scipy>=1.10.1 \
        soundfile>=0.13.1 \
        loguru>=0.7.3 \
        einops>=0.8.1 \
        accelerate>=1.12.0 \
        fastapi>=0.110.0 \
        diskcache \
        "uvicorn[standard]>=0.27.0" \
        numba>=0.63.1 \
        vector-quantize-pytorch>=1.27.15 \
        torchao \
        modelscope \
        peft>=0.7.0 \
        lightning>=2.0.0 \
        tensorboard>=2.0.0 \
        xxhash \
        -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com || \
    pip install transformers>=4.51.0,<4.58.0 \
        diffusers \
        gradio>=6.5.1 \
        matplotlib>=3.7.5 \
        scipy>=1.10.1 \
        soundfile>=0.13.1 \
        loguru>=0.7.3 \
        einops>=0.8.1 \
        accelerate>=1.12.0 \
        fastapi>=0.110.0 \
        diskcache \
        "uvicorn[standard]>=0.27.0" \
        numba>=0.63.1 \
        vector-quantize-pytorch>=1.27.15 \
        torchao \
        modelscope \
        peft>=0.7.0 \
        lightning>=2.0.0 \
        tensorboard>=2.0.0 \
        xxhash

# 尝试安装 nano-vllm（可能需要特殊编译）
RUN if [ -d "acestep/third_parts/nano-vllm" ]; then \
        pip install -e acestep/third_parts/nano-vllm || echo "Warning: nano-vllm installation failed"; \
    fi

# 创建工作目录并赋权
RUN mkdir -p /app/checkpoints /app/outputs /app/logs && \
    chown -R 1001:1001 /app

EXPOSE 7860
VOLUME [ "/app/checkpoints", "/app/outputs", "/app/logs" ]

# 使用 ACE-Step 1.5 的新入口点
ENTRYPOINT ["python3", "acestep/acestep_v15_pipeline.py", "--server-name", "0.0.0.0", "--port", "7860"]

